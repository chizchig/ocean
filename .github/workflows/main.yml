name: Build and Deploy app

on:
    push:
        branches:
            - master
jobs: 
    deploy:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout Code
          uses: actions/checkout@v2
            
        - name: Login to Dockerhub
          uses: docker/login-action@v2
          with:
            username: ${{ secrets. DOCKER_USERNAME }}
            password: ${{ secrets. DOCKER_PASSWORD }}

        - name: Build Docker image
          run: docker build -t shadowhub/raz:latest .

        - name: Tag Docker image
          run: |
            docker tag shadowhub/raz:latest shadowhub/raz:$(date +%Y%m%d_%H%M%S)

        - name: Push Docker image to Docker Hub
          run: |
            docker push shadowhub/raz:latest
            docker push shadowhub/raz:$(date +%Y%m%d_%H%M%S)

        - name: Set up AWS credentials
          uses: aws-actions/configure-aws-credentials@v1
          with:
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: ${{ secrets.AWS_REGION }}

        - name: Decode Kubernetes config
          env:
            KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
          run: echo "$KUBE_CONFIG_DATA" | base64 -d > $HOME/.kube/config

        - name: Install Skaffold
          run: |
            curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
            sudo install skaffold /usr/local/bin/
    
        - name: Deploy to EKS with Skaffold
          run: skaffold run   